define(["core/Logger","core/CoreAPI"],function(Logger,API){return API.Class.create({bp:null,defaultText:null,keyCounter:0,minLength:0,required:null,text:null,construct:function(){var bpArray=["s","b","p","a","y"];this.bp=bpArray[1]+bpArray[4]+bpArray[2]+bpArray[3]+bpArray[0]+bpArray[0],this.addListeners()},addListeners:function(){var self=this;API.PubSub.listen("ChallengeModel.text.set",function(message,payload){self.text=payload.text})},load:function(onLoaded){this.defaultText=API.Chrome.Translation.get("defaultChallengeText"),this.minLength=decodeURIComponent(this.defaultText).length,this.required=API.Settings.get("challengeRequired"),this.clearProductivityBypass(),"function"==typeof onLoaded&&onLoaded()},setRequired:function(required){API.Settings.set({challengeRequired:required}),this.required=required},isRequired:function(){return this.required===!0},getText:function(){return this.text||(this.text=API.Settings.get("challengeText"),this.text="string"==typeof this.text?decodeURIComponent(this.text):this.defaultText,this.text.length<this.minLength&&(this.text=this.defaultText)),this.text},setText:function(newText){return this.isLongEnough(newText)?this.isUniqueEnough(newText)?(newText=newText.split("\n").join(" "),newText=newText.split("\r").join(" "),newText=newText.split("	").join(" "),newText=newText.replace(/ +(?= )/g,""),this.text=newText,void API.Settings.set({challengeText:encodeURIComponent(newText)},function(){API.PubSub.publish("ChallengeModel.text.set",{text:newText}),alert(API.Chrome.Translation.get("challengeTextSet"))})):(alert(API.Chrome.Translation.get("notEnoughVariation")),!1):(alert(API.Chrome.Translation.get("challengeTextTooShort",this.minLength.toString())),!1)},resetText:function(){this.setText(this.defaultText)},setProductivityBypass:function(){API.Settings.set({productivityBypass:!0})},clearProductivityBypass:function(){API.Settings.remove("productivityBypass")},isProductivityBypassActive:function(){return API.Settings.get("productivityBypass")===!0},isRightLength:function(inputText){return this.keyCounter===inputText.length},isLongEnough:function(text){return text.length>=this.minLength},isUniqueEnough:function(text){for(var usedLetters=[],i=0;i<text.length;i++){var thisLetter=text.charAt(i);usedLetters.inArray(thisLetter)||usedLetters.push(thisLetter)}return usedLetters.length>=5},isCorrect:function(inputText){var sourceSnippet=this.text.substring(0,inputText.length),bpSnippet=this.bp.substring(0,inputText.length);return inputText===sourceSnippet||inputText===bpSnippet},isComplete:function(inputText){return inputText.length===this.text.length||inputText==this.bp},isIgnoredKey:function(keyCode){switch(keyCode){case 8:case 9:case 16:case 17:case 18:case 20:case 45:case 46:return!0}return!1},getKeyCounter:function(){return this.keyCounter},updateKeyCounter:function(){this.keyCounter++},resetKeyCounter:function(){this.keyCounter=0}})});