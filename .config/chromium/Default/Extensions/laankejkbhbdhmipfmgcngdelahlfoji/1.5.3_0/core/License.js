define(["core/Logger","core/CoreAPI","core/vendor/jquery.min"],function(Logger,API,$){var LICENSE_API_URL="https://www.googleapis.com/chromewebstore/v1.1/userlicenses/",MIN_CACHE_TTL=12,GRACE_PERIOD=24,GRACE_PERIOD_MS=60*GRACE_PERIOD*60*1e3,licenseType={NONE:"cff9423590531e1c22a7017e188b56c219cbc796",FREE_TRIAL:"5ac242823d0b112240b5461d8ce3c1997f186804",FULL:"489bfa3f55ceb76ffad6f26b17018fadcec78d40"},License={dateCached:null,dateCacheExpired:null,dateCreated:null,exists:null,hash:null,initAPI:function(theAPI){API=theAPI,API.mixin("License",{load:this.load.bind(this),isFull:this.isFull.bind(this),isTrial:this.isTrial.bind(this)})},load:function(){var self=this;API.Chrome.Identity.getAuthToken({interactive:!0},function(token){if("undefined"==typeof token)self.onTokenFailed();else{API.Storage.setBucket("license","SYNC",!0);var license=API.Settings.get("license")||null;if(license){for(var prop in license)license.hasOwnProperty(prop)&&(self[prop]=license[prop]);self.isCachedLicenseExpired()&&self.fetch(token)}else self.fetch(token)}})},isFull:function(){return this.exists===!0&&this.hash===licenseType.FULL||this.isGracePeriodActive()},isTrial:function(){return!this.isFull()},fetch:function(token){var request=$.ajax({type:"GET",url:LICENSE_API_URL+API.Chrome.Extension.getID(),headers:{Authorization:"Bearer "+token}});request.done(this.onLicenseLoaded.bind(this)),request.fail(this.onLicenseFailed.bind(this))},onTokenFailed:function(){this.exists=!1},onLicenseFailed:function(request,textStatus,errorThrown){this.exists=!1},onLicenseLoaded:function(license){this.dateCached=(new Date).getTime(),this.dateCacheExpired=this.getCacheExpirationTS(license),this.dateCreated=parseInt(license.createdTime),this.exists=license.result,this.hash=licenseType[license.accessLevel]||licenseType.NONE,this.cacheLicense()},cacheLicense:function(){var cacheObj={};for(var prop in this)this.hasOwnProperty(prop)&&"function"!=typeof this[prop]&&(cacheObj[prop]=this[prop]);API.Settings.set({license:cacheObj},null,"SYNC")},getCacheExpirationTS:function(license){var minCacheTTLSecs=60*MIN_CACHE_TTL*60,licenseTTLSecs=parseInt(license.maxAgeSecs),cacheTTLSecs=licenseTTLSecs>minCacheTTLSecs?licenseTTLSecs:minCacheTTLSecs;return this.dateCached+1e3*cacheTTLSecs},isCachedLicenseExpired:function(){var currentTS=(new Date).getTime();return currentTS>this.dateCacheExpired},isGracePeriodActive:function(){var currentTS=(new Date).getTime(),gracePeriodExpirationTS=this.dateCreated+GRACE_PERIOD_MS;return gracePeriodExpirationTS>currentTS}};return License});