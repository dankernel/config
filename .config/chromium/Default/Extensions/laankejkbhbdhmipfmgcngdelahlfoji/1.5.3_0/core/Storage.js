define(["core/Logger","core/ObjectUtils"],function(Logger,ObjectUtils){var API,Storage={LOCAL:1,SYNC:2,HTML5:3,map:null,cache:{},initAPI:function(theAPI){API=theAPI,API.mixin("Storage",{addOnChangeListener:this.addOnChangeListener.bind(this),init:this.init.bind(this),get:this.get.bind(this),getAll:this.getAll.bind(this),set:this.set.bind(this),merge:this.merge.bind(this),remove:this.remove.bind(this),setBucket:this.setBucket.bind(this),setHTML5:this.setHTML5.bind(this),getHTML5:this.getHTML5.bind(this),removeHTML5:this.removeHTML5.bind(this)})},init:function(callback){var self=this;this.cache={},this.map=null,this.getSynced("storageMap",function(map){"undefined"!=typeof map?self.map=map:(self.map={},self.saveMap()),"function"==typeof callback&&callback()})},get:function(key,callback,forceRefresh){callback="function"==typeof callback?callback:function(){},this.inCache(key)&&!forceRefresh?callback(this.getCached(key)):this.inSync(key)?this.getSynced(key,callback):this.inHTML5(key)?callback(this.getHTML5(key)):this.getLocal(key,callback)},refresh:function(key,callback){this.get(key,callback,!0)},getAll:function(bucket,callback){if(bucket="string"==typeof bucket?bucket.toUpperCase():bucket,"function"!=typeof callback)throw new Error("[Storage.getAll()] callback must be a function");if(bucket)"SYNC"===bucket?API.Chrome.Storage.getSync(null,callback):"LOCAL"===bucket?API.Chrome.Storage.getLocal(null,callback):"HTML5"===bucket&&callback(localStorage);else{var settings={};API.Chrome.Storage.getSync(null,function(sync){settings.SYNC=sync,API.Chrome.Storage.getLocal(null,function(local){settings.LOCAL=local,settings.HTML5=localStorage,callback(settings)})})}},set:function(obj,callback,bucket){callback="function"==typeof callback?callback:function(){},bucket="string"==typeof bucket?bucket.toUpperCase():null;var sync={},local={},hasSync=!1,hasLocal=!1,syncComplete=!1,localComplete=!1;for(var key in obj)obj.hasOwnProperty(key)&&(this.inSync(key)||"SYNC"==bucket?(sync[key]=obj[key],hasSync=!0):this.inHTML5(key)||"HTML5"==bucket?this.setHTML5(key,obj[key]):(local[key]=obj[key],hasLocal=!0));hasSync&&this.setSynced(sync,function(){syncComplete=!0,(!hasLocal||localComplete)&&callback()}),hasLocal&&this.setLocal(local,function(){localComplete=!0,(!hasSync||syncComplete)&&callback()}),hasSync||hasLocal||callback()},remove:function(key,callback,bucket){callback="function"==typeof callback?callback:function(){},this.inSync(key)||"SYNC"===bucket?this.removeSynced(key,callback):this.inHTML5(key)||"HTML5"===bucket?(this.removeHTML5(key),callback()):this.removeLocal(key,callback),"undefined"!=typeof this.map[key]&&(delete this.map[key],this.saveMap())},merge:function(key,to,from,callback){var self=this;"SYNC"===from?this.getSynced(key,function(source){self.getLocal(key,function(target){self.doMerge(key,to,target,source,callback)})}):"LOCAL"===from&&this.getLocal(key,function(source){self.getSynced(key,function(target){self.doMerge(key,to,target,source,callback)})})},doMerge:function(key,to,target,source,callback){target=ObjectUtils.isObjLiteral(target)?target:{},source=ObjectUtils.isObjLiteral(source)?source:{},this.remove(key),this.setBucket(key,to,!0);var obj={};obj[key]=ObjectUtils.merge(target,source,!0),this.set(obj,callback)},setBucket:function(key,bucket,skipMigration){if(this.isArray(key))for(var i=0;i<key.length;i++)this.setBucket(key[i],bucket,skipMigration);else"string"==typeof key&&("string"==typeof bucket&&(bucket=bucket.toUpperCase()),bucket="undefined"!=typeof this[bucket]?bucket:"HTML5",this.map[key]=this[bucket],this.saveMap(),"HTML5"!==bucket&&skipMigration!==!0&&this.migrate(key,bucket))},saveMap:function(map){map=map||this.map,this.setSynced({storageMap:map})},migrate:function(key,to){var self=this;"SYNC"===to?this.getLocal(key,function(value){var obj={};obj[key]=value,self.setSynced(obj),self.removeLocal(key)}):"LOCAL"===to&&this.getSynced(key,function(value){var obj={};obj[key]=value,self.setLocal(obj),self.removeSynced(key)})},addOnChangeListener:function(listener){listener="function"==typeof listener?listener:function(){},API.Chrome.Storage.addListener("onChanged",listener)},inCache:function(key){return"undefined"!=typeof this.cache[key]},inSync:function(key){return this.map[key]===this.SYNC},inLocal:function(key){return this.map[key]===this.LOCAL},inHTML5:function(key){return this.map[key]===this.HTML5},setCached:function(items){for(var i in items)items.hasOwnProperty(i)&&(this.cache[i]=items[i])},getCached:function(key){return this.cache[key]},removeCached:function(key){delete this.cache[key]},setSynced:function(items,callback){callback="function"==typeof callback?callback:function(){},this.setCached(items);for(var i in items)items.hasOwnProperty(i)&&this.setHTML5("sync_"+i,JSON.stringify(items[i]));API.Chrome.Storage.setSync(items,callback)},getSynced:function(key,callback){callback="function"==typeof callback?callback:function(){};var self=this;API.Chrome.Storage.getSync(key,function(items){if("string"==typeof key){if("undefined"==typeof items){var syncBackup=self.getHTML5("sync_"+key);items={},items[key]=JSON.parse(syncBackup)||{}}self.setCached(items),callback(items[key])}else callback(items)})},removeSynced:function(key,callback){callback="function"==typeof callback?callback:function(){},this.removeCached(key),this.removeHTML5("sync_"+key),API.Chrome.Storage.removeSync(key,callback)},setLocal:function(items,callback){callback="function"==typeof callback?callback:function(){},this.setCached(items),API.Chrome.Storage.setLocal(items,callback)},getLocal:function(key,callback){callback="function"==typeof callback?callback:function(){};var self=this;API.Chrome.Storage.getLocal(key,function(items){if("string"==typeof key){items=items||{};var value=items[key];("undefined"==typeof value||null===value)&&(value=self.getFromLocalStorageBackup(key));var cacheObj={};cacheObj[key]=value,self.setCached(cacheObj),callback(value)}else callback(items)})},getFromLocalStorageBackup:function(key){var value=null,lsValue=localStorage.getItem(key);if("undefined"!=typeof lsValue&&null!==lsValue){try{value=JSON.parse(lsValue)}catch(e){value=lsValue}var obj={};obj[key]=value,this.setLocal(obj)}return value},removeLocal:function(key,callback){callback="function"==typeof callback?callback:function(){},this.removeCached(key),API.Chrome.Storage.removeLocal(key,callback)},setHTML5:function(key,value){var obj={};obj[key]=value,this.setCached(obj),localStorage.setItem(key,value)},getHTML5:function(key){var value=localStorage.getItem(key),obj={};return obj[key]=value,this.setCached(obj),value},removeHTML5:function(key){this.removeCached(key),localStorage.removeItem(key)},isArray:function(obj){return"object"==typeof obj&&null!==obj&&"number"==typeof obj.length}};return Storage});